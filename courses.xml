<?xml version="1.0" encoding="utf-8"?>
<form table="ut_materials" >


<insert
	redirect="?act=insert_course&amp;id=$insertid;"
	sql="set @a=@Image;
#set @error=if(@PriceType;=0 and (@Price;='' or @Price=0),'Вы должны ввести цену платного курса','')
#set @p=if(@PriceType;=0,@Price,0)
#insert into ut_materials (TypeID,StatusID,Name, UserID, Date, CategoryID, Active, Description, FullDescription, Price, PriceType)
		values(4,7,@Name;, '$auth->user;',  unix_timestamp(), @CategoryID;, 0, @Description;, @FullDescription;, @Price;, @PriceType; );
#set @MaterialID='$insertid;'
#insert ignore into ut_materials_approve (select * from ut_materials where ID=@MaterialID and UserID='$auth->user;');" 
	success_rus="Курс создан!" success_eng="Record added" button="Submit">

    <fields>
        <field name="Name" size="49" width="400" name_rus="Название курса" type="string" valign="top" maxlength="60" needed="1" showlimit="1" />
		<field name="CategoryID" name_rus="Категория" type="sqlist" sql="select * from ut_categories order by Name" hint_rus="Категория, к которой относится курс" needed="1"/>
        <field name="Image" needed="0" name_rus="Иллюстрация для каталога" 
			quality="100" type="image_popup" fixwidth="430" fixheight="300" width="215" height="150"/>
        <field name="Description" name_rus="Краткое описание курса" maxlength="200" width="400" hint_rus="Опишите кратко задачи, цели курса" showlimit="1" type="text" needed="1"/>
		<field name="FullDescription" height="400" format='Default' colspan="2" width="1150" name_rus="Подробное описание курса&lt;br>" type="editor"  needed="1"/>
		<!--<field name="ModulesType" name_rus="Как открывать уроки?" needed="1" type="sqlist" sql="select * from ut_modules_types" >1</field>-->
		<field name="PriceType" name_rus="Стоимость" vars_rus="Платный курс&lt;div id='pricefield'>
			Цена в рублях: &lt;input name='Price' data-type=numeric type=text maxlength='' value='$Price;' size=3  onkeypress='javascript: return checknumeric(event)'/>
			&lt;/div>;Бесплатный курс" 
			format="onchange=&quot;
			document.getElementById('pricefield').style.display=(this.value==1)?'none':'block'
			&quot;" 
			type="radio" needed="1">
		</field>
    </fields>
   <button name_rus="Продолжить" name_eng="Add record"></button>

 </insert>
		
		
 <select 
 success_rus="Изменения сохранены"
 sql="select v.*,
 concat(v.Price,' руб.') Price,
 if(v.Active=1,'Да', 'Нет') as Active,
 c.Name Category,
 if(v.Featured=1,'Да', 'Нет') as Featured,
 concat(coalesce(group_concat(concat('&lt;li>',m.Name) separator '&lt;br>'),''),
 '&lt;a href=modules.php?id=',v.ID,'&amp;act=insert>&lt;br>добавить урок&lt;/a>
 &lt;a href=modules.php?id=',v.ID,'>&lt;br>изменить&lt;/a>') Modules,
 
 concat('&lt;b>&lt;a href=?act=update&amp;id=',v.ID,'>',v.Name,'&lt;/a>&lt;/b>',
 if(v.StatusID=2,concat('&lt;br>&lt;font color=red>',v.AdminComment,'&lt;/font>'),'')) Name,
 
concat('&lt;nobr>&lt;span class=status_',v.StatusID,' title=&quot;',st.Name_$lang;,'&quot; align=absmiddle>&lt;/span> ',st.Name_$lang;,'&lt;/nobr>') Status,
 if(v.Vip=1,'Да', 'Нет') as Vip, (select Login from ut_users where UserID=v.UserID) as Login
 from ut_materials v
join ut_categories c on c.categoryid=v.categoryid
join ut_statuses st on st.statusid=v.statusid
left outer join ut_modules m on m.materialid=v.id
where v.TypeID=4 and v.StatusID!=6
and v.UserID='$auth->user;'
group by v.ID
order by v.date desc"

pagecount="10" width="100%"  framed="0" tableclass="class='dataGrid'">
    <header>
        <item name="Icon" name_rus=" " type="icon"  width="215px" src="ut_materials/small/$ID;.jpg" >?act=update&amp;id=$ID;</item>
        <item name="Name" name_rus="Название курса"/>
        <item name="Price" name_rus="Цена" align="right"/>
		<item name="Category" name_rus="Категория"  />
		<item name="Status" name_rus="Статус" name_eng=" "   />
		<item type="edit" />
		<item type="delete" />
		<!--
        <item name="Modules" name_rus="Модули"/>
        
        
		
		-->
    </header>
</select>

<insert2 sql="set @a=@Image;
#set @error=if(@PriceType;=0 and (@Price;='' or @Price=0),'Вы должны ввести цену платного курса','')
#set @p=if(@PriceType;=0,@Price,0)
#insert into ut_materials (TypeID,StatusID,Name, UserID, Date, CategoryID, Active)
values (4,7,@Name;, '$auth->user;',  unix_timestamp(), @CategoryID;, 0 )
#insert ignore into ut_materials_approve (select * from ut_materials where ID=@id and UserID='$auth->user;')" 

	redirect="?act=update&amp;id=$id;&amp;form_ok=1" 
	success_rus="Курс создан. Теперь заполните его содержание." 
	success_eng="Record changed" 
	error_eng="Record not found" 
	error_rus="Курс не найден2">
   
    <fields>

		<field name="Name" size="50" name_rus="Название курса" type="string" maxlength="60" needed="1" showlimit="1" />
		<field name="CategoryID" name_rus="Категория" type="sqlist" sql="select * from ut_categories order by Name" hint_rus="Категория, к которой относится курс" needed="1"/>
        <field name="Image" needed="0" name_rus="Иллюстрация для каталога" 
			quality="100" type="image_popup" fixwidth="430" fixheight="300" width="215" height="150"/>
        <field name="Description" name_rus="Краткое описание" maxlength="200" showlimit="1" type="text" needed="1"/>
		<field name="FullDescription" height="400" name_rus="Подробное описание&lt;br>" colspan="2" type="editor"  needed="1"/>
		<!--<field name="ModulesType" name_rus="Как открывать уроки?" needed="1" type="sqlist" sql="select * from ut_modules_types" >1</field>-->
		<field name="PriceType" name_rus="Стоимость" vars_rus="Платный курс&lt;div id='pricefield'>
			Цена в рублях: &lt;input name='Price' data-type=numeric type=text maxlength='' value='$Price;' size=3  onkeypress='javascript: return checknumeric(event)'/>
			&lt;/div>;Бесплатный курс" 
			format="onchange=&quot;
			document.getElementById('pricefield').style.display=(this.value==1)?'none':'block'
			&quot;" 
			type="radio" needed="1">
		</field>

	</fields>
	
	<button name_rus="Продолжить" name_eng="Add record"/>
 </insert2>
 
 
 <update  success_rus="Изменения сохранены" >
     <fields>
	 </fields>
 </update>
 
  <insert_course  success_rus="Курс создан. Теперь Вам необдохимо добавить уроки. После добавления уроков Вы сможете опубликовать курс в каталоге." >
     <fields>
	 </fields>
 </insert_course>
 
<publicate sql="set @error=if(@Active;=0 or (select count(*) from ut_modules where MaterialID=@id; and StatusID!=6)>0,'',
'Перед публикацией &lt;a href=modules.php?act=insert&amp;id=$id;>добавьте&lt;/a> хотя бы один урок')
#update ut_materials set 
Active=@Active;,
DateActive=@DateActive;,

StatusID=if(StatusID in (4) and @Active=0, 3,
			if(StatusID=3 and @Active=1, 4,
			if(StatusID in (2,7) and @Active=1,1,
				if(@Active=0 and StatusID=1,7,StatusID))))

  where ID=@id;  and UserId='$auth->user;'"


redirect="?act=update&amp;id=$id;"
        select="select *, UserID as User from ut_materials where ID=@id; and UserID='$auth->user;'" 
        success_rus="Курс отправлен на модерацию"
        success_eng="Record changed" 
        error_eng="Record not found" 
        error_rus="Курс не найден">
   
    <fields>

	<field name="Hint" name_rus="Для того, чтобы опубликовать курс в каталоге, поставьте галочку &quot;Опубликовать&quot;. &lt;br>Курс появится в каталоге после того, как пройдет проверку модератором."

	type="label" colspan="2" maxlength="255" needed="1"/>
        <field name="Name" name_rus="Название курса" type="label" maxlength="255" needed="1"/>

		<field name="Active" name_rus="Опубликовать" type="checkbox" needed="0"/>

        <field name="DateActive" name_rus="Дата публикации" type="datetime" datepicker="1"
		sql="select if(@DateActive;='',unix_timestamp(),@DateActive;)"
		hint_rus="Дата, с которой курс будет доступен в каталоге" needed="0"/>



    </fields>
   <button name_rus="Сохранить изменения" name_eng="Add record">
   </button>

 </publicate>
 
 <updateprice sql="set @error=if(@PriceType;=0 and (@Price;='' or @Price=0),'Вы должны ввести цену платного курса','')
#set @p=if(@PriceType;=0,@Price,0)
#update ut_materials set 
OldPrice=Price, Price=@p,  PriceBonus=@PriceBonus;

  where ID=@id;  and UserId='$auth->user;'" 

redirect="?act=update&amp;id=$id;"
        select="select *, UserID as User,if(Price=0,1,0) PriceType,if(Price=0,'none','block') display from ut_materials where ID=@id; and UserID='$auth->user;'" 
      success_rus="Данные обновлены" >
   
    <fields>

        <field name="Name" name_rus="Название курса" type="label" maxlength="255" needed="1"/>



<field name="PriceType" name_rus="Стоимость" vars_rus="Платный курс&lt;div id='pricefield' style='display:$display;'>
Цена в рублях: &lt;input name='Price' id='PriceType' data-type=numeric type=text maxlength='' value='$Price;' size=3  onkeypress='javascript: return checknumeric(event)'/>
&lt;/div>;Бесплатный курс"
format="onchange=&quot;
document.getElementById('pricefield').style.display=(this.value==1)?'none':'block';
&quot;" type="radio" needed="1"/>



    </fields>

   <button name_rus="Сохранить" name_eng="Add record">
   </button>

 </updateprice>


 <delete 
 redirect="?act=select"
 sql="set @error=if((select count(*) from ut_members where MaterialID=@id; and userid!='$auth->user;')>0,'Нельзя удалить курс, в котором есть активные участники','')
 #update ut_materials set StatusID=6 where ID=@id; and UserId='$auth->user;'" success_rus="Курс удален" success_eng="Record deleted">
 </delete>

  <cancelupdate
 redirect="?act=select"
 sql="delete from ut_materials_approve where UserID='$auth->user;' and ID=@id;
 #insert into ut_materials_approve (select * from ut_materials where UserID='$auth->user;' and ID=@id;)" 
 
 success_rus="Курс удален" success_eng="Record deleted">
 </cancelupdate>
 
 <updateinfo 
 table="ut_materials_approve"
 sql="set @a=@Image;
#set @status=(select StatusID from ut_materials where ID=@id;)
#set @table=if(@status in (1,7),'','_approve')
#update ut_materials$table; set 
FullDescription=@FullDescription;,
ModulesType=@ModulesType;,
UserComment=@UserComment;,
Name=@Name;, Description=@Description;, Keywords=@Keywords;, CategoryID=@CategoryID;,
DateUpdated=unix_timestamp(),StatusID=if(@table='',StatusID,7)

  where ID=@id;  and UserId='$auth->user;'" 

		redirect="?act=update&amp;id=$id;"

        select="select * from ut_materials 
		where ID=@id;  and UserID='$auth->user;' and StatusID in (1,7)
		union (select * from ut_materials_approve
		where ID=@id;  and UserID='$auth->user;') limit 1"
		
        success_rus="Изменения сохранены" 
        success_eng="Record changed" 
        error_eng="Record not found" 
        error_rus="Курс не найден">
   
    <fields>

       <field name="Name" size="50" name_rus="Название курса" type="string" maxlength="60" needed="1" showlimit="1" />
		<field name="CategoryID" name_rus="Категория" type="sqlist" sql="select * from ut_categories order by Name" hint_rus="Категория, к которой относится курс" needed="1"/>

        <!--test-->
        <field name="Image" needed="0" name_rus="Иллюстрация для каталога" 
			   quality="100" 
			   type="image_popup" 
			   fixwidth="430" fixheight="300"
            width="215" height="150"/>
		
        <field name="Description" 
		name_rus="Краткое описание" maxlength="200"  showlimit="1" type="text" needed="1"/>
		
		<field name="FullDescription" height="400" name_rus="Подробное описание&lt;br>" colspan="2" type="editor"  needed="1"/>
		
<!--        <field name="Keywords" name_rus="Ключевые слова для поиска" type="string" maxlength="255" needed="0"/>-->

      <!--  <field name="ModulesType" 
		name_rus="Как открывать уроки?" type="sqlist" sql="select * from ut_modules_types" />-->
		
		
        <field name="UserComment" 
		name_rus="Комментарий" type="string" size="100" hint_rus="Если Ваш курс уже размещен в каталоге, или был отклонен, напишите здесь о том, что изменилось" />
		

    </fields>
   <button name_rus="Сохранить" name_eng="Add record">
   </button>

 </updateinfo>

</form>
